# Treehouse Comparative Analysis of RNA Expression
[UCSC Treehouse Childhood Cancer Initiative](http://treehousegenomics.ucsc.edu)

## Documentation on the docker used in the [Vaske 2019 comparative tumor RNA-Seq analysis publication](https://treehousegenomics.ucsc.edu/p/vaske-2019-comparative-tumor-RNA/) is available [here](docs/Vaske-2019-comparative-tumor-RNA.md).

Treehouse Comparative Analysis of RNA Expression (CARE) is a dockerized chain of Jupyter notebook that performs outlier analysis on an 
[uniformly generated](https://github.com/UCSC-Treehouse/pipelines) RNA-Seq expression file vs a background compendium of samples.

## Before you start
Before you get started, please note that this pipeline requires a reference compendium of RNA-Seq samples to use as a background for calculating the focus sample's outliers.
This compendium consists of an expression matrix, a clinical matrix, and a variety of reference files. However, there is not currently a publicly-accessible
compatible compendium (including reference files) for the current version of the pipeline as the format has been updated since the
 [0.8.0.1-compatible compendium](docs/Vaske-2019-comparative-tumor-RNA.md) was created.

We are working to make a background-ready version of the [Tumor Compendium v10 Public PolyA](https://treehousegenomics.soe.ucsc.edu/public-data/#tumor_v10_polyA) and will update
when it is available.

Additionally, the input samples are assumed to be in the storage layout generated by the [Treeshop](https://github.com/UCSC-Treehouse/pipelines/blob/master/treeshop.md) cluster
processing fab.

## Usage

```git clone https://github.com/UCSC-Treehouse/CARE.git```

Checkout the [latest release](https://github.com/UCSC-Treehouse/CARE/releases) by its tag:

```git checkout 0.14.4.0```

Build the docker:

```docker build -t ucsctreehouse/CARE:$USER .```

In your workdir, create an output dir:

```mkdir outputs```

- In your workdir, create a tab-separated file named "`manifest.tsv`" listing the samples you wish to run. (Details below.)

  - Populate the paths to your input directories and docker version.
  
    - COMPENDIUM_PATH : The path to the desired background compendium
    - REFERENCES_PATH : Path to your static extra references dir
    - INPUTS_PATH : The directory containing your input samples
    - CARE_VERSION : your built docker's version
    
    For example:
  ```
     COMPENDIUM_PATH=/data/treehouse/compendium/v10_polya
     REFERENCES_PATH=/data/treehouse/external-references
     INPUTS_PATH=/data/treehouse/downstream
     CARE_VERSION=$USER
        
     ```
  
  - Then, call the docker:

```
docker run --user $UID --rm -it \
                -v $COMPENDIUM_PATH:/work/cohort:ro \
                -v $REFERENCES_PATH:/work/references:ro \
                -v $INPUTS_PATH:/work/inputs:ro \
                -v `pwd`/manifest.tsv:/app/manifest.tsv:ro \
                -v `pwd`/outputs:/work/outputs \
                -v `pwd`:/work/rollup:ro \
                ucsctreehouse/care:$CARE_VERSION
```

The tertiary results will be placed in `outputs/`.

### manifest.tsv Format
The manifest lists the samples you wish to perfom tertiary on.

It searches for those samples in the `/work/inputs` directory within the docker.
If it doesn't find a named sample in that directory, it skips it and continues to the next sample.

The manifest is formatted as a tab-separated file. All columns beyond the first are optional.


Sample ID | Disease | Curated Cohort Filename | Sample Alias
-|-|-|-
EXAMPLE1 | osteosarcoma | | |
EXAMPLE2 | Very Rare Disease | example2curated-july31.txt |
TEST_EXAMPLE3 | rhabdomyosarcoma | | EXAMPLE3

Sample ID: The identifier of the sample. We expect a dir with this name to be present in `/work/inputs`.
Disease: The diagnosis of the sample. The formatting must match the way the diagnosis is formatted in the compendium.
Curated Cohort Filename: The filename of the curated cohort (see below).
Sample Alias: If this sample is already in the compendium, but has a different ID, provide that ID as an alias so that its compendium version
can be excluded from comparison.

In the example above, EXAMPLE2 is a typical sample.
EXAMPLE2 has a disease that's not present in the compendium, so we provide a curated cohort.
TEST\_EXAMPLE3 is a modification of EXAMPLE3 which is present in the compendium, so we list its alias as EXAMPLE3.

#### Curated Cohort
If there are fewer than 20 samples in the compendium with a disease that matches the provided one, tertiary analysis cannot provide
reliable disease-specific comparison. In this case, it will request that you create a curated cohort file.
This file contains at least 20 sample IDs, 1 per line, which must be present in the compendium. These samples will be used as a substite
disease-specific cohort to allow reliable analysis. The file should be placed in the working directory; or, you can place it in a subdir
and specify that folder's name in the curated cohort column:
Eg, "cohort.txt" if it's in the working directory, or "curated/cohort.txt" if it's in a `curated` subdir.

The directory containing curated cohorts is currently referred to as `/work/rollup` within the docker.

## Filling out annotations.json

Output for this code includes Summary.html and Slides.html documents. When you first open them, they will have some values populated
but in general they will be full of placeholder text.
The secret to fixing this is the annotations.json file. When you have annotations.json in the same dir as these HTMLs, you can fill out
the values in it and they will automatically appear in the HTML documents via JavaScript.

In addition, creating images with certain names will automatically populate the slots:
- pathway.png : pathway diagram
- tumormap.png : tumormap image
- findings.png : heatmap with findings prioritization

## Repo Structure

- Code is developed in feature branches and merged into develop as completed. A set of changes is merged into master to be a release.  A release branch is made from master, and the release tag is attached to that release branch.

